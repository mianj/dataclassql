{% set name = model.name %}
{% set insert_class = name ~ 'Insert' %}
{% set insert_dict_class = name ~ 'InsertDict' %}
{% set where_dict_class = name ~ 'WhereDict' %}
{% set table_class = name ~ 'Table' %}

{{ model.include_alias }} = {{ model.include_literal_expr }}
{{ model.sortable_alias }} = {{ model.sortable_literal_expr }}

@dataclass(slots=True, kw_only=True)
class {{ insert_class }}:
{{ macros.dataclass_fields(model.insert_fields)|indent(4, True) }}

class {{ insert_dict_class }}(TypedDict):
{{ macros.typed_dict_fields(model.typed_dict_fields)|indent(4, True) }}

class {{ where_dict_class }}(TypedDict, total=False):
{{ macros.where_fields(model.where_fields)|indent(4, True) }}

class {{ table_class }}:
    model = {{ name }}
    insert_model = {{ insert_class }}
    datasource = {{ model.datasource_expr }}
{{ macros.column_specs(model.column_specs)|indent(4, True) }}
    column_specs_by_name: Mapping[str, ColumnSpec] = MappingProxyType({spec.name: spec for spec in column_specs})
    primary_key: tuple[str, ...] = {{ model.primary_key_literal }}
    indexes: tuple[tuple[str, ...], ...] = {{ model.indexes_literal }}
    unique_indexes: tuple[tuple[str, ...], ...] = {{ model.unique_indexes_literal }}
{{ macros.foreign_keys(model.foreign_keys)|indent(4, True) }}
{{ macros.relations(model.relation_entries)|indent(4, True) }}

    def __init__(self, backend: BackendProtocol[{{ name }}, {{ insert_class }}, {{ where_dict_class }}]) -> None:
        self._backend: BackendProtocol[{{ name }}, {{ insert_class }}, {{ where_dict_class }}] = backend

    def insert(self, data: {{ insert_class }} | {{ insert_dict_class }}) -> {{ name }}:
        return self._backend.insert(self, data)

    def insert_many(self, data: Sequence[{{ insert_class }} | {{ insert_dict_class }}], *, batch_size: int | None = None) -> list[{{ name }}]:
        return self._backend.insert_many(self, data, batch_size=batch_size)

    def find_many(self, *, where: {{ where_dict_class }} | None = None, include: dict[{{ model.include_alias }}, bool] | None = None, order_by: Sequence[tuple[{{ model.sortable_alias }}, Literal['asc', 'desc']]] | None = None, take: int | None = None, skip: int | None = None) -> list[{{ name }}]:
        return self._backend.find_many(self, where=where, include=cast(Mapping[str, bool] | None, include), order_by=order_by, take=take, skip=skip)

    def find_first(self, *, where: {{ where_dict_class }} | None = None, include: dict[{{ model.include_alias }}, bool] | None = None, order_by: Sequence[tuple[{{ model.sortable_alias }}, Literal['asc', 'desc']]] | None = None, skip: int | None = None) -> {{ name }} | None:
        return self._backend.find_first(self, where=where, include=cast(Mapping[str, bool] | None, include), order_by=order_by, skip=skip)
